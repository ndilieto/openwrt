From 5460c024b13cc0a7863318d4018ec107b4fb8e01 Mon Sep 17 00:00:00 2001
From: Daniel Schwierzeck <daniel.schwierzeck@gmail.com>
Date: Sun, 13 Oct 2013 14:56:45 +0200
Subject: [PATCH 004/158] sf: add slim probe funtions for SPL

Signed-off-by: Daniel Schwierzeck <daniel.schwierzeck@gmail.com>
---
 drivers/mtd/spi/sf_probe.c | 55 ++++++++++++++++++++++++++++++++++++++++++++++
 include/spi_flash.h        |  3 +++
 2 files changed, 58 insertions(+)

diff --git a/drivers/mtd/spi/sf_probe.c b/drivers/mtd/spi/sf_probe.c
index 92bc419e57..9078b0f12a 100644
--- a/drivers/mtd/spi/sf_probe.c
+++ b/drivers/mtd/spi/sf_probe.c
@@ -391,3 +391,58 @@ void spi_flash_free(struct spi_flash *flash)
 	spi_free_slave(flash->spi);
 	free(flash);
 }
+
+#ifdef CONFIG_SPI_SPL_SIMPLE
+int spl_spi_flash_probe(struct spi_flash *flash)
+{
+	struct spi_slave *spi;
+	u8 idcode[5];
+	int ret;
+
+	/* Setup spi_slave */
+	spi = spi_setup_slave(CONFIG_SPL_SPI_BUS, CONFIG_SPL_SPI_CS,
+		CONFIG_SPL_SPI_MAX_HZ, CONFIG_SPL_SPI_MODE);
+	if (!spi) {
+		debug("SF: Failed to set up slave\n");
+		return -1;
+	}
+
+	/* Claim spi bus */
+	ret = spi_claim_bus(spi);
+	if (ret) {
+		debug("SF: Failed to claim SPI bus: %d\n", ret);
+		goto err_claim_bus;
+	}
+
+	/* Read the ID codes */
+	ret = spi_flash_cmd(spi, CMD_READ_ID, idcode, sizeof(idcode));
+	if (ret) {
+		debug("SF: Failed to get idcodes\n");
+		goto err_read_id;
+	}
+
+	/* Validate params from spi_flash_params table */
+	flash->spi = spi;
+	ret = spi_flash_validate_params(flash, idcode);
+	if (ret)
+		goto err_read_id;
+
+	/* Release spi bus */
+	spi_release_bus(spi);
+
+	return 0;
+
+err_read_id:
+	spi_release_bus(spi);
+err_claim_bus:
+	spi_free_slave(spi);
+	flash->spi = NULL;
+
+	return ret;
+}
+
+void spl_spi_flash_free(struct spi_flash *flash)
+{
+	spi_free_slave(flash->spi);
+}
+#endif
diff --git a/include/spi_flash.h b/include/spi_flash.h
index 2db53c74c8..dc2629c8ed 100644
--- a/include/spi_flash.h
+++ b/include/spi_flash.h
@@ -139,6 +139,9 @@ struct spi_flash *spi_flash_probe_fdt(const void *blob, int slave_node,
 
 void spi_flash_free(struct spi_flash *flash);
 
+int spl_spi_flash_probe(struct spi_flash *flash);
+void spl_spi_flash_free(struct spi_flash *flash);
+
 static inline int spi_flash_read(struct spi_flash *flash, u32 offset,
 		size_t len, void *buf)
 {
-- 
2.11.0

