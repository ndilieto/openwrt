From cd8c0f71061fcaece3d2235f5c8cdd4acca09dfc Mon Sep 17 00:00:00 2001
From: Daniel Schwierzeck <daniel.schwierzeck@gmail.com>
Date: Fri, 28 Aug 2015 18:05:48 +0200
Subject: [PATCH 011/158] common/board_r: init SPI flash MTD

Signed-off-by: Daniel Schwierzeck <daniel.schwierzeck@gmail.com>
---
 common/board_r.c           |  4 ++++
 drivers/mtd/spi/sf_probe.c | 24 +++++++++++++++++++-----
 include/spi_flash.h        |  2 ++
 3 files changed, 25 insertions(+), 5 deletions(-)

diff --git a/common/board_r.c b/common/board_r.c
index 602a239380..8e8dad8e9e 100644
--- a/common/board_r.c
+++ b/common/board_r.c
@@ -42,6 +42,7 @@
 #include <scsi.h>
 #include <serial.h>
 #include <spi.h>
+#include <spi_flash.h>
 #include <stdio_dev.h>
 #include <trace.h>
 #include <watchdog.h>
@@ -802,6 +803,9 @@ init_fnc_t init_sequence_r[] = {
 #if defined(CONFIG_X86) && defined(CONFIG_SPI)
 	init_func_spi,
 #endif
+#ifdef CONFIG_SPI_FLASH_MTD
+	spi_flash_mtd_init,
+#endif
 #ifdef CONFIG_CMD_NAND
 	initr_nand,
 #endif
diff --git a/drivers/mtd/spi/sf_probe.c b/drivers/mtd/spi/sf_probe.c
index 9300160ce3..61f8948072 100644
--- a/drivers/mtd/spi/sf_probe.c
+++ b/drivers/mtd/spi/sf_probe.c
@@ -383,10 +383,6 @@ static struct spi_flash *spi_flash_probe_slave(struct spi_slave *spi)
 	}
 #endif
 
-	ret = spi_flash_mtd_register(flash);
-	if (ret)
-		goto err_read_id;
-
 	/* Release spi bus */
 	spi_release_bus(spi);
 
@@ -424,7 +420,6 @@ struct spi_flash *spi_flash_probe_fdt(const void *blob, int slave_node,
 
 void spi_flash_free(struct spi_flash *flash)
 {
-	spi_flash_mtd_unregister();
 	spi_free_slave(flash->spi);
 	free(flash);
 }
@@ -483,3 +478,22 @@ void spl_spi_flash_free(struct spi_flash *flash)
 	spi_free_slave(flash->spi);
 }
 #endif
+
+#ifdef CONFIG_SPI_FLASH_MTD
+int spi_flash_mtd_init(void)
+{
+	struct spi_flash *flash;
+	int ret = 0;
+
+	flash = spi_flash_probe(CONFIG_ENV_SPI_BUS, CONFIG_ENV_SPI_CS,
+			CONFIG_ENV_SPI_MAX_HZ, CONFIG_ENV_SPI_MODE);
+	if (!flash)
+		return -1;
+
+	ret = spi_flash_mtd_register(flash);
+	if (ret)
+		spi_flash_free(flash);
+
+	return ret;
+}
+#endif
diff --git a/include/spi_flash.h b/include/spi_flash.h
index 738c43c8a5..9bc39ef8d7 100644
--- a/include/spi_flash.h
+++ b/include/spi_flash.h
@@ -164,4 +164,6 @@ static inline int spi_flash_erase(struct spi_flash *flash, u32 offset,
 void spi_boot(void) __noreturn;
 void spi_spl_load_image(uint32_t offs, unsigned int size, void *vdst);
 
+int spi_flash_mtd_init(void);
+
 #endif /* _SPI_FLASH_H_ */
-- 
2.11.0

